#!/bin/bash
## ~/.local/bin/start-sway
# ============================================================
# 1. 环境初始化
# ============================================================
export USER_ID=$(id -u)
export XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR:-/run/user/$USER_ID}
export WAYLAND_DISPLAY=${WAYLAND_DISPLAY:-wayland-0}
export DISPLAY=${DISPLAY:-:0}
export XDG_SESSION_DESKTOP=sway
export XDG_SESSION_TYPE=wayland

# 确保运行时目录权限正确 (Wayland 对此非常敏感)
[ ! -d "$XDG_RUNTIME_DIR" ] && mkdir -p "$XDG_RUNTIME_DIR"
chmod 700 "$XDG_RUNTIME_DIR"

# ============================================================
# 2. 图形驱动与硬件加速配置 (关键修复区)
# ============================================================
# 优先使用 WSL 专用库路径
export LD_LIBRARY_PATH=/usr/lib/wsl/lib:$LD_LIBRARY_PATH
# 强制使用 Mesa 提供的 D3D12 桥接驱动
export __GLX_VENDOR_LIBRARY_NAME=mesa
export GALLIUM_DRIVER=d3d12

# 阻止加载导致段错误的 NVIDIA Linux 原生库 (核心修复)
MESA_JSON="/usr/share/glvnd/egl_vendor.d/50_mesa.json"
if [ -f "$MESA_JSON" ]; then
    export __EGL_VENDOR_LIBRARY_FILENAMES="$MESA_JSON"
fi

# ============================================================
# 3. WSLg 通道映射
# ============================================================
# 重新建立 X11 链路 (确保 XWayland 和 X11 程序可用)
if mountpoint -q /tmp/.X11-unix; then umount /tmp/.X11-unix; fi
rm -rf /tmp/.X11-unix && mkdir -p /tmp/.X11-unix && chmod 1777 /tmp/.X11-unix
ln -sf /mnt/wslg/.X11-unix/X0 /tmp/.X11-unix/X0

# 重新建立 Wayland 链路
ln -sf /mnt/wslg/runtime-dir/wayland-0 ${XDG_RUNTIME_DIR}/${WAYLAND_DISPLAY}
ln -sf /mnt/wslg/runtime-dir/wayland-0.lock ${XDG_RUNTIME_DIR}/${WAYLAND_DISPLAY}.lock

# ============================================================
# 4. 启动 D-Bus 与 Sway
# ============================================================
# 确保 Systemd 用户实例已启动
if [[ ! -e ${XDG_RUNTIME_DIR}/bus ]]; then
    systemctl --user start dbus.socket
fi

# 启动 Sway 进程
dbus-run-session sway > /tmp/sway.log 2>&1 &

# ============================================================
# 5. 就绪检查与后期处理
# ============================================================
echo "Waiting for Sway to initialize..."
for i in {1..20}; do
    if swaymsg -t get_outputs >/dev/null 2>&1; then
        echo "Sway is active on $WAYLAND_DISPLAY"
        swaymsg "workspace 1"
        break
    fi
    sleep 0.5
done